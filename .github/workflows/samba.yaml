name: OpenWrt Package Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout OpenWrt
        uses: actions/checkout@v4
        with:
          repository: openwrt/openwrt
          ref: v24.10.2
          path: openwrt

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache git wget python3 unzip \
            libncurses5-dev zlib1g-dev gawk flex gettext libssl-dev xsltproc rsync

      - name: Setup ccache
        run: |
          echo 'export PATH="/usr/lib/ccache:$PATH"' >> $GITHUB_ENV
          echo 'export CCACHE_DIR="$HOME/.ccache"' >> $GITHUB_ENV
          echo 'export CCACHE_COMPRESS=1' >> $GITHUB_ENV
          echo 'export CCACHE_MAXSIZE=2G' >> $GITHUB_ENV

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-x86-${{ github.ref }}
          restore-keys: |
            ccache-${{ runner.os }}-x86-

      - name: Cache toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir
            openwrt/build_dir/toolchain*
            openwrt/tmp
          key: toolchain-${{ runner.os }}-x86-${{ github.ref }}
          restore-keys: |
            toolchain-${{ runner.os }}-x86-

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Replace liburing & samba4
        run: |
          cd openwrt
          rm -rf feeds/packages/libs/liburing
          git clone https://github.com/sbwml/feeds_packages_libs_liburing feeds/packages/libs/liburing
          rm -rf feeds/packages/net/samba4
          git clone https://github.com/sbwml/feeds_packages_net_samba4 feeds/packages/net/samba4

      - name: Build toolchain
        run: |
          cd openwrt
          make toolchain/install -j$(nproc) V=s

      - name: Build packages
        run: |
          cd openwrt
          make package/feeds/packages/liburing/compile -j$(nproc) V=s
          make package/feeds/packages/samba4/compile -j$(nproc) V=s

      - name: Debug - List built IPKs
        run: |
          echo "=== List of built .ipk files ==="
          find openwrt/bin/packages/ -type f -name "*.ipk" | sort

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-ipk
          path: |
            openwrt/bin/packages/*/packages/liburing*.ipk
            openwrt/bin/packages/*/packages/samba4*.ipk
          if-no-files-found: warn
          compression-level: 6
