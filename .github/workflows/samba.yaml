name: openwrt-ipk-x86

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget ccache

    - name: Clone OpenWrt
      run: |
        git clone https://github.com/openwrt/openwrt.git
        cd openwrt
        git checkout v24.10.2

    - name: Replace feeds
      run: |
        cd openwrt
        rm -rf feeds/packages/libs/liburing
        git clone https://github.com/sbwml/feeds_packages_libs_liburing feeds/packages/libs/liburing
        rm -rf feeds/packages/net/samba4
        git clone https://github.com/sbwml/feeds_packages_net_samba4 feeds/packages/net/samba4

    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure target (x86_64)
      run: |
        cd openwrt
        cat > .config <<EOF
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_Generic=y
        CONFIG_PACKAGE_liburing=y
        CONFIG_PACKAGE_samba4-server=y
        EOF
        
        make defconfig

    - name: Cache toolchain
      uses: actions/cache@v4
      with:
        path: |
          openwrt/staging_dir
          openwrt/build_dir/toolchain*
          openwrt/tmp
        key: ${{ runner.os }}-toolchain-x86-${{ github.ref_name }}
        restore-keys: |
          ${{ runner.os }}-toolchain-x86-

    - name: Build toolchain
      run: |
        cd openwrt
        make toolchain/install -j$(nproc) V=s

    - name: Build packages (liburing + samba4)
      run: |
        cd openwrt
        make package/liburing/compile -j$(nproc) V=s
        make package/samba4/compile -j$(nproc) V=s

    - name: Debug built files
      run: |
        echo "=== List of built .ipk files ==="
        find openwrt/bin/packages -type f -name "*.ipk" -print || true

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-ipk-x86
        path: |
          openwrt/bin/packages/*/*/liburing*.ipk
          openwrt/bin/packages/*/*/samba4*.ipk
        if-no-files-found: warn

    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          openwrt/bin/packages/*/*/liburing*.ipk
          openwrt/bin/packages/*/*/samba4*.ipk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
